# Bundle Optimization Plan

**Version:** 1.1.0
**Date:** 2026-01-17
**Status:** Phase 1 & 2 Complete
**Target:** Reduce initial bundle from 1.79 MB to <500 KB

---

## Executive Summary

Console.web's production bundle was **1,792.60 KB** (462 KB gzipped), significantly exceeding the recommended 500 KB warning threshold. This plan addresses the issue through code-splitting, lazy loading, and dependency cleanup.

### Results Achieved

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| Main JS Bundle (raw) | 1,792.60 KB | 225.57 KB | **-87%** |
| Main JS Bundle (gzip) | 462.35 KB | 60.32 KB | **-87%** |
| CSS Bundle | 105.61 KB | 105.72 KB | No change |
| Components Loaded | 38 eager | 12 eager | **-68%** |
| Code-split Chunks | 1 | 28 | **+27 chunks** |

### Current Chunk Distribution

| Chunk | Size (raw) | Size (gzip) | Load Timing |
|-------|------------|-------------|-------------|
| index.js (main) | 225.57 KB | 60.32 KB | Initial |
| vendor-react | 141.00 KB | 45.31 KB | Initial |
| vendor-socket | 41.84 KB | 13.05 KB | Initial |
| vendor-icons | 7.84 KB | 2.14 KB | Initial |
| vendor-terminal | 299.74 KB | 75.44 KB | On project select |
| vendor-sentry | 261.01 KB | 85.89 KB | Async |
| vendor-markdown | 118.29 KB | 36.53 KB | On note edit |
| AdminDashboard | 491.73 KB | 94.83 KB | On admin open |
| VoiceCommandPanel | 29.63 KB | 8.70 KB | On voice open |
| 19 modal chunks | 2-25 KB each | 1-7 KB each | On demand |

**Initial Load (gzipped):** ~121 KB (index + react + socket + icons)
**With Terminal:** ~196 KB (adds vendor-terminal)

### Implementation Status

| Phase | Status | Notes |
|-------|--------|-------|
| Phase 1: Quick Wins | COMPLETE | Tailwind fixed, vendor chunks split |
| Phase 2: Lazy Loading | COMPLETE | 20+ components lazy loaded |
| Phase 3: Chunk Config | COMPLETE | Manual chunks configured |
| Phase 4: Component Optimization | PENDING | SettingsPanel, WidgetDashboard refactor |

---

## Phase 1: Quick Wins (Immediate)

### 1.1 Fix Tailwind Safelist Warning

**Problem:** Current pattern doesn't match any classes:
```javascript
// tailwind.config.js - CURRENT (broken)
safelist: [
  { pattern: /^\[data-theme=/ },  // Warns: doesn't match any classes
]
```

**Solution:** Remove the safelist entry entirely. The `[data-theme="..."]` selectors are defined in `index.css` as custom CSS, not generated by Tailwind. They're preserved automatically.

```javascript
// tailwind.config.js - FIXED
safelist: [
  // No entries needed - all dynamic classes use object lookups with literal strings
  // Theme selectors are in index.css, not Tailwind-generated
]
```

### 1.2 Remove Unused Dependencies

These packages are in `package.json` but **never imported** in frontend code:

| Package | Size | Action |
|---------|------|--------|
| chart.js | ~6.8 MB | Remove or move to devDependencies |
| react-dnd | ~1.6 MB | Remove |
| react-dnd-html5-backend | ~656 KB | Remove |
| prismjs | ~6.6 MB | Remove (not directly imported) |

```bash
npm uninstall chart.js react-dnd react-dnd-html5-backend prismjs
```

### 1.3 Disable Production Sourcemaps

```javascript
// vite.config.js
build: {
  sourcemap: process.env.NODE_ENV === 'development',  // Only in dev
}
```

**Impact:** Reduces build output by ~5.7 MB (sourcemap file).

---

## Phase 2: Code Splitting Strategy

### 2.1 Lazy Load Modals

All 11+ modals should use `React.lazy()`:

```javascript
// App.jsx - BEFORE
import KeyboardShortcutsModal from './components/KeyboardShortcutsModal';
import ThemePicker from './components/ThemePicker';
import CreateProjectModal from './components/CreateProjectModal';
// ... 8 more modals

// App.jsx - AFTER
const KeyboardShortcutsModal = lazy(() => import('./components/KeyboardShortcutsModal'));
const ThemePicker = lazy(() => import('./components/ThemePicker'));
const CreateProjectModal = lazy(() => import('./components/CreateProjectModal'));
// ... 8 more modals
```

**Modals to Lazy Load:**
- KeyboardShortcutsModal
- ThemePicker
- SessionTemplateModal
- ShareModal
- HandoffModal
- ExportModal
- ImportWizard (677 lines)
- CreateProjectModal (997 lines)
- GitHubSettingsModal
- GitHubRepoList
- AboutModal (730 lines)

### 2.2 Lazy Load Admin Features

```javascript
// App.jsx - Admin components
const AdminDashboard = lazy(() => import('./components/AdminDashboard'));
const SettingsPanel = lazy(() => import('./components/SettingsPanel'));
const CodePuppyDashboard = lazy(() => import('./components/CodePuppyDashboard'));
const TabbyDashboard = lazy(() => import('./components/TabbyDashboard'));
const SwarmDashboard = lazy(() => import('./components/SwarmDashboard'));
```

### 2.3 Lazy Load Development Tools

```javascript
// App.jsx - Dev tools (rarely used on initial load)
const FileBrowser = lazy(() => import('./components/FileBrowser'));
const DatabaseBrowser = lazy(() => import('./components/DatabaseBrowser'));
const ApiTester = lazy(() => import('./components/ApiTester'));
const GitWorkflow = lazy(() => import('./components/GitWorkflow'));
const DependencyDashboard = lazy(() => import('./components/DependencyDashboard'));
```

### 2.4 Suspense Wrapper Component

```javascript
// src/components/shared/LazyWrapper.jsx
import { Suspense } from 'react';

export function LazyWrapper({ children, fallback = <LoadingSpinner /> }) {
  return (
    <Suspense fallback={fallback}>
      {children}
    </Suspense>
  );
}

// Usage in App.jsx
{showAdminDashboard && (
  <LazyWrapper>
    <AdminDashboard />
  </LazyWrapper>
)}
```

---

## Phase 3: Vite Manual Chunks Configuration

### 3.1 Vendor Chunk Separation

```javascript
// vite.config.js
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    host: '0.0.0.0',
    port: 7777,
    allowedHosts: ['manager.example.com', 'manage.example.com', 'localhost'],
    proxy: {
      '/api': { target: 'http://localhost:5275', changeOrigin: true },
      '/auth': { target: 'http://localhost:5275', changeOrigin: true },
      '/socket.io': { target: 'http://localhost:5275', ws: true, changeOrigin: true },
    },
  },
  build: {
    outDir: 'dist',
    sourcemap: false,
    rollupOptions: {
      output: {
        manualChunks: {
          // Core vendor libraries
          'vendor-react': ['react', 'react-dom'],
          'vendor-socket': ['socket.io-client'],
          'vendor-icons': ['lucide-react'],

          // Terminal (heavy, only needed when project selected)
          'vendor-terminal': ['xterm', 'xterm-addon-fit', '@xterm/addon-serialize'],

          // Search (loaded with CommandPalette)
          'vendor-search': ['fuse.js'],

          // Markdown rendering (session notes only)
          'vendor-markdown': ['react-markdown', 'remark-gfm'],

          // Sentry (can load async)
          'vendor-sentry': ['@sentry/react'],
        },
      },
    },
  },
});
```

### 3.2 Expected Chunk Output

After implementation:

| Chunk | Contents | Est. Size (gzip) |
|-------|----------|------------------|
| index | Core app shell, routing | ~80 KB |
| vendor-react | React, ReactDOM | ~45 KB |
| vendor-terminal | xterm + addons | ~90 KB |
| vendor-socket | Socket.IO client | ~25 KB |
| vendor-icons | Lucide React | ~15 KB |
| vendor-search | Fuse.js | ~8 KB |
| admin | AdminDashboard, Settings | ~60 KB |
| modals | All modal components | ~50 KB |
| tools | FileBrowser, ApiTester, etc. | ~40 KB |

**Total Initial Load:** ~150-180 KB (vs current 462 KB)

---

## Phase 4: Component-Level Optimization

### 4.1 Priority Refactoring Targets

| Component | Lines | Issue | Action |
|-----------|-------|-------|--------|
| SettingsPanel.jsx | 1,915 | Monolithic | Split into 6 sub-components |
| WidgetDashboard.jsx | 1,198 | Complex logic | Extract widget logic to hooks |
| App.jsx | 1,171 | 38 imports | Lazy load 25+ components |
| ProjectContextMenu.jsx | 1,052 | 5 fetch calls | Consolidate API calls |
| CodePuppyDashboard.jsx | 1,049 | 10+ states | Extract to useCodePuppy hook |
| CreateProjectModal.jsx | 997 | Multi-step form | Split wizard steps |

### 4.2 Keep in Initial Bundle

These components are needed immediately and should NOT be lazy-loaded:

- **Terminal.jsx** - Core feature, always visible
- **HomeDashboard.jsx** - Default view on load
- **LeftSidebar.jsx** - Always visible navigation
- **RightSidebar.jsx** - Always visible stats
- **CommandPalette.jsx** - Frequently invoked (Cmd+K)

---

## Implementation Checklist

### Phase 1: Quick Wins
- [ ] Fix tailwind.config.js safelist (remove broken pattern)
- [ ] Audit and remove unused npm dependencies
- [ ] Disable production sourcemaps
- [ ] Verify build size reduction

### Phase 2: Lazy Loading
- [ ] Add React.lazy imports for all modals (11 components)
- [ ] Add React.lazy imports for admin features (5 components)
- [ ] Add React.lazy imports for dev tools (5 components)
- [ ] Create LazyWrapper component with Suspense
- [ ] Add loading states for lazy components
- [ ] Test all lazy-loaded components work correctly

### Phase 3: Chunk Configuration
- [ ] Update vite.config.js with manualChunks
- [ ] Verify chunk separation in build output
- [ ] Test all chunks load correctly
- [ ] Measure improvement with Lighthouse

### Phase 4: Component Optimization
- [ ] Split SettingsPanel.jsx into sub-components
- [ ] Extract CodePuppy logic to custom hook
- [ ] Consolidate ProjectContextMenu API calls
- [ ] Review remaining large components

---

## Success Metrics

| Metric | Before | Target | Stretch |
|--------|--------|--------|---------|
| JS Bundle (gzip) | 462 KB | <200 KB | <150 KB |
| Initial Load | 38 components | 12 components | 8 components |
| Lighthouse Perf | TBD | 85+ | 90+ |
| FCP | TBD | <1.8s | <1.2s |
| TTI | TBD | <3.5s | <2.5s |

---

## Monitoring & Validation

### Bundle Analysis

```bash
# Install bundle analyzer
npm install -D rollup-plugin-visualizer

# Add to vite.config.js
import { visualizer } from 'rollup-plugin-visualizer';

plugins: [
  react(),
  visualizer({ open: true, gzipSize: true }),
]
```

### Lighthouse CI

```bash
# Run after each build
npx lighthouse http://localhost:7777 --output html --output-path ./lighthouse-report.html
```

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Lazy component flash | Use skeleton loaders in Suspense fallback |
| Network errors on chunk load | Add error boundaries with retry logic |
| Breaking changes | Test all features after each phase |
| Performance regression | Benchmark before/after each change |

---

## Timeline

| Phase | Duration | Dependencies |
|-------|----------|--------------|
| Phase 1: Quick Wins | 1-2 hours | None |
| Phase 2: Lazy Loading | 4-6 hours | Phase 1 |
| Phase 3: Chunk Config | 2-3 hours | Phase 2 |
| Phase 4: Components | 8-12 hours | Phase 3 |

**Total Estimated:** 15-23 hours

---

**Document Version:** 1.0.0
**Created:** 2026-01-17
**Next Review:** After Phase 2 completion

# Console.web Prometheus Alerting Rules
# Add these to your Prometheus configuration

groups:
  - name: console-web
    interval: 30s
    rules:
      # High Error Rate
      - alert: ConsoleWebHighErrorRate
        expr: |
          (
            sum(rate(consoleweb_http_requests_total{status_code=~"5.."}[5m]))
            /
            sum(rate(consoleweb_http_requests_total[5m]))
          ) * 100 > 5
        for: 2m
        labels:
          severity: critical
          service: console-web
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | printf \"%.2f\" }}% (threshold: 5%)"
          runbook: "Check server logs for errors: pm2 logs console-web --err"

      # High Response Time
      - alert: ConsoleWebHighResponseTime
        expr: |
          histogram_quantile(0.95, sum(rate(consoleweb_http_request_duration_seconds_bucket[5m])) by (le)) > 1
        for: 5m
        labels:
          severity: warning
          service: console-web
        annotations:
          summary: "High p95 response time"
          description: "P95 response time is {{ $value | printf \"%.2f\" }}s (threshold: 1s)"
          runbook: "Check for slow database queries or resource contention"

      # Service Down
      - alert: ConsoleWebDown
        expr: up{job="console-web"} == 0
        for: 1m
        labels:
          severity: critical
          service: console-web
        annotations:
          summary: "Console.web service is down"
          description: "The console-web service has been unreachable for more than 1 minute"
          runbook: "Check PM2 status: pm2 status console-web; pm2 logs console-web"

      # High Memory Usage
      - alert: ConsoleWebHighMemory
        expr: |
          process_resident_memory_bytes{job="console-web"} / 1024 / 1024 > 450
        for: 5m
        labels:
          severity: warning
          service: console-web
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value | printf \"%.0f\" }}MB (threshold: 450MB)"
          runbook: "Consider restarting the service: pm2 restart console-web"

      # Rate Limit Exceeded
      - alert: ConsoleWebRateLimitHits
        expr: |
          sum(rate(consoleweb_http_requests_total{status_code="429"}[5m])) > 1
        for: 5m
        labels:
          severity: warning
          service: console-web
        annotations:
          summary: "Rate limiting is active"
          description: "{{ $value | printf \"%.2f\" }} requests/s are being rate limited"
          runbook: "Check for potential abuse or consider adjusting rate limits"

      # WebSocket Connection Spike
      - alert: ConsoleWebHighWebSocketConnections
        expr: consoleweb_websocket_connections > 50
        for: 5m
        labels:
          severity: warning
          service: console-web
        annotations:
          summary: "High number of WebSocket connections"
          description: "{{ $value }} WebSocket connections active (threshold: 50)"
          runbook: "Check for connection leaks or unusual client behavior"

      # No Requests (Service might be broken)
      - alert: ConsoleWebNoTraffic
        expr: |
          sum(rate(consoleweb_http_requests_total[10m])) == 0
        for: 15m
        labels:
          severity: warning
          service: console-web
        annotations:
          summary: "No traffic to console-web"
          description: "No HTTP requests received in the last 15 minutes"
          runbook: "Verify service is accessible and check reverse proxy configuration"

      # High Database Query Time
      - alert: ConsoleWebSlowDatabaseQueries
        expr: |
          histogram_quantile(0.95, sum(rate(consoleweb_db_query_duration_seconds_bucket[5m])) by (le)) > 0.5
        for: 5m
        labels:
          severity: warning
          service: console-web
        annotations:
          summary: "Slow database queries detected"
          description: "P95 database query time is {{ $value | printf \"%.2f\" }}s (threshold: 0.5s)"
          runbook: "Check database performance and query optimization"

      # Terminal Sessions High
      - alert: ConsoleWebHighTerminalSessions
        expr: consoleweb_terminal_sessions > 20
        for: 10m
        labels:
          severity: info
          service: console-web
        annotations:
          summary: "Many terminal sessions active"
          description: "{{ $value }} terminal sessions are currently active"
          runbook: "This is informational - check if sessions are being properly cleaned up"

      # Critical Response Time (Phase 4.4.2)
      - alert: ConsoleWebCriticalResponseTime
        expr: |
          histogram_quantile(0.95, sum(rate(consoleweb_http_request_duration_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: critical
          service: console-web
        annotations:
          summary: "Critical p95 response time"
          description: "P95 response time is {{ $value | printf \"%.2f\" }}s (threshold: 2s)"
          runbook: "Immediate action required - check for system resource exhaustion, database issues, or deadlocks"

      # Database Pool Exhaustion (Phase 4.4.3)
      - alert: ConsoleWebDatabasePoolExhausted
        expr: consoleweb_db_pool_waiting > 0
        for: 1m
        labels:
          severity: critical
          service: console-web
        annotations:
          summary: "Database connection pool exhausted"
          description: "{{ $value }} clients waiting for database connections (pool_size: {{ printf \"consoleweb_db_pool_size\" | query | first | value }}, idle: {{ printf \"consoleweb_db_pool_idle\" | query | first | value }})"
          runbook: "Check for connection leaks, long-running transactions, or increase pool size"

      # Database Pool Near Exhaustion
      - alert: ConsoleWebDatabasePoolNearExhaustion
        expr: |
          (consoleweb_db_pool_size - consoleweb_db_pool_idle) / consoleweb_db_pool_size > 0.8
        for: 5m
        labels:
          severity: warning
          service: console-web
        annotations:
          summary: "Database pool usage > 80%"
          description: "Pool utilization at {{ $value | printf \"%.0f\" }}%"
          runbook: "Monitor closely - may need to increase pool size or optimize queries"

      # Socket.IO Disconnect Rate (Phase 4.4.4)
      - alert: ConsoleWebHighSocketDisconnectRate
        expr: |
          sum(rate(consoleweb_websocket_connections[5m])) < -0.5
        for: 5m
        labels:
          severity: warning
          service: console-web
        annotations:
          summary: "High Socket.IO disconnect rate"
          description: "Connections dropping at {{ $value | printf \"%.2f\" }}/s"
          runbook: "Check network stability, server resources, and client-side connection handling"

      # Socket.IO Connection Churn (connects/disconnects happening frequently)
      - alert: ConsoleWebSocketConnectionChurn
        expr: |
          abs(sum(deriv(consoleweb_websocket_connections[5m]))) > 1
        for: 10m
        labels:
          severity: warning
          service: console-web
        annotations:
          summary: "High Socket.IO connection churn"
          description: "Connections are being established and dropped frequently"
          runbook: "Investigate client reconnection behavior and network stability"
